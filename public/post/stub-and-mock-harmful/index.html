<!DOCTYPE HTML>

<html>
    <head>
        
            
                <title>Are Stubs and Mocks Harmful?</title>
            
        

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="generator" content="Hugo 0.25.1" />
        
    
        
    

    

    <link rel="apple-touch-icon-precomposed"
        href='https://www.lvguowei.me/favicon/apple-touch-icon-precomposed.png'>
    <link rel="icon" href='https://www.lvguowei.me/favicon/favicon.png'>
    
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-TileImage"
        content='/favicon/mstile.png'>



        
        
            
                <meta name="description" content="Guowei Lv">
            
        

        

  <meta name="twitter:card" content="summary"/>



<meta name="twitter:text:title" content="Are Stubs and Mocks Harmful?"/>
<meta name="twitter:title" content="Are Stubs and Mocks Harmful?"/>
<meta name="twitter:description" content="I stumbled upon this video, and boy it is so amazing! (if you ignore the annoying audience asking non-stop some annoying questions). This is clearly one of the most inspiring videos I have ever watched. So I must take some notes down and spread the idea as well.
I deeply believe that it is actually easy to make things complicated, on the contrary, it is hard to make things simple and elegant."/>


        <meta property="og:title" content="Are Stubs and Mocks Harmful?" />
<meta property="og:description" content="I stumbled upon this video, and boy it is so amazing! (if you ignore the annoying audience asking non-stop some annoying questions). This is clearly one of the most inspiring videos I have ever watched. So I must take some notes down and spread the idea as well.
I deeply believe that it is actually easy to make things complicated, on the contrary, it is hard to make things simple and elegant." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.lvguowei.me/post/stub-and-mock-harmful/" />



<meta property="article:published_time" content="2016-12-18T19:53:45&#43;02:00"/>
<meta property="article:modified_time" content="2016-12-18T19:53:45&#43;02:00"/>











        
<meta itemprop="name" content="Are Stubs and Mocks Harmful?">
<meta itemprop="description" content="I stumbled upon this video, and boy it is so amazing! (if you ignore the annoying audience asking non-stop some annoying questions). This is clearly one of the most inspiring videos I have ever watched. So I must take some notes down and spread the idea as well.
I deeply believe that it is actually easy to make things complicated, on the contrary, it is hard to make things simple and elegant.">


<meta itemprop="dateModified" content="2016-12-18T19:53:45&#43;02:00" />
<meta itemprop="wordCount" content="991">



<meta itemprop="keywords" content="TDD,mocks,stubs," />

        

        

        
        
            
        

        
        
            <link rel="stylesheet" href="https://www.lvguowei.me/css/google-font.css" />
            <link rel="stylesheet" href="https://www.lvguowei.me/css/font-awesome.min.css" />
            <link rel="stylesheet" href="https://www.lvguowei.me/css/main.css" />
            <link rel="stylesheet" href="https://www.lvguowei.me/css/add-on.css" />
            <link rel="stylesheet" href="https://www.lvguowei.me/css/monokai-sublime.css">
        

        

        
        
        
            
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-71831707-2', 'auto');
ga('send', 'pageview');
</script>

        
    </head>
    <body>

        
        <div id="wrapper">

    
    
<header id="header">
    
        <h2><a href="https://www.lvguowei.me/">Guowei Lv</i></a></h2>
    

    <nav class="links">
        <ul>
            
                <li>
                    <a href="https://www.lvguowei.me/post">
                        
                            <i class="fa fa-newspaper-o">&nbsp;</i>Blog
                    </a>
                </li>
            
                <li>
                    <a href="https://www.lvguowei.me/categories">
                        Categories
                    </a>
                </li>
            
                <li>
                    <a href="https://www.lvguowei.me/about">
                        About
                    </a>
                </li>
            
        </ul>
    </nav>
    <nav class="main">
        <ul>
            
            <li id="share-nav" class="share-menu" style="display:none;">
                <a class="fa-share-alt" href="#share-menu">Share</a>
            </li>
            
            <li class="search">
                <a class="fa-search" href="#search">Search</a>
                <form id="search" method="get" action="//google.com/search">
                  <input type="text" name="q" placeholder="Search" />
                  <input type="hidden" name="as_sitesearch" value="https://www.lvguowei.me/">
                </form>
            </li>
            <li class="menu">
                <a class="fa-bars" href="#menu">Menu</a>
            </li>
        </ul>
    </nav>
</header>


<section id="menu">

    
        <section>
            <form class="search" method="get" action="//google.com/search">
                <input type="text" name="q" placeholder="Search" />
                <input type="hidden" name="q" value="site:https://www.lvguowei.me/">
            </form>
        </section>

    
        <section>
            <ul class="links">
                
                    <li>
                        <a href="https://www.lvguowei.me/post">
                            <h3>
                                
                                    <i class="fa fa-newspaper-o">&nbsp;</i>
                                
                                Blog
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="https://www.lvguowei.me/categories">
                            <h3>
                                
                                Categories
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="https://www.lvguowei.me/about">
                            <h3>
                                
                                About
                            </h3>
                        </a>
                    </li>
                
            </ul>
        </section>

    
        <section>
            <ul class="links">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    <li>
                        <a href="https://www.lvguowei.me/post/all-you-need-to-know-about-android-espresso-testing-4/"><p>All You Need To Know About Android Espresso Testing (Part IV)</p></a>
                    </li>
                
                    <li>
                        <a href="https://www.lvguowei.me/post/all-you-need-to-know-about-android-espresso-testing-3/"><p>All You Need To Know About Android Espresso Testing (Part III)</p></a>
                    </li>
                
                    <li>
                        <a href="https://www.lvguowei.me/post/all-you-need-to-know-about-android-espresso-testing-2/"><p>All You Need To Know About Android Espresso Testing (Part II)</p></a>
                    </li>
                
                    <li>
                        <a href="https://www.lvguowei.me/post/how-to-follow-hand-made-hero-on-linux/"><p>How To Follow Hand Made Hero On Linux</p></a>
                    </li>
                
                    <li>
                        <a href="https://www.lvguowei.me/post/all-you-need-to-know-about-android-espresso-testing/"><p>All You Need To Know About Android Espresso Testing (Part I)</p></a>
                    </li>
                
            </ul>
        </section>

    
        
</section>

    <section id="share-menu">
    <section id="social-share-nav">
        <ul class="links">
            <header>
                <h3>Share this post <i class="fa fa-smile-o"></i></h3>
            </header>
            


<li><a href="//twitter.com/share?url=https%3a%2f%2fwww.lvguowei.me%2fpost%2fstub-and-mock-harmful%2f&text=Are%20Stubs%20and%20Mocks%20Harmful%3f&via=" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
</a></li>


<li><a href="//plus.google.com/share?url=https%3a%2f%2fwww.lvguowei.me%2fpost%2fstub-and-mock-harmful%2f" target="_blank" class="share-btn google-plus">
    <i class="fa fa-google-plus"></i>
    <p>Google+</p>
</a></li>


<li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.lvguowei.me%2fpost%2fstub-and-mock-harmful%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
</a></li>


<li><a href="//reddit.com/submit?url=https%3a%2f%2fwww.lvguowei.me%2fpost%2fstub-and-mock-harmful%2f&title=Are%20Stubs%20and%20Mocks%20Harmful%3f" target="_blank" class="share-btn reddit">
    <i class="fa fa-reddit-alien"></i>
    <p>Reddit</p>
</a></li>


<li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.lvguowei.me%2fpost%2fstub-and-mock-harmful%2f&title=Are%20Stubs%20and%20Mocks%20Harmful%3f" target="_blank" class="share-btn linkedin">
    <i class="fa fa-linkedin"></i>
    <p>LinkedIn</p>
</a></li>


<li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fwww.lvguowei.me%2fpost%2fstub-and-mock-harmful%2f&title=Are%20Stubs%20and%20Mocks%20Harmful%3f" target="_blank" class="share-btn stumbleupon">
    <i class="fa fa-stumbleupon"></i>
    <p>StumbleUpon</p>
</a></li>


<li><a href="mailto:?subject=Check out this post by &body=https%3a%2f%2fwww.lvguowei.me%2fpost%2fstub-and-mock-harmful%2f" target="_blank" class="share-btn email">
    <i class="fa fa-envelope"></i>
    <p>Email</p>
</a></li>

        </ul>
    </section>
</section>

    
    <div id="main">
        
        
        <article class="post">
    <header>
    <div class="title">
        
            <h1><a href="https://www.lvguowei.me/post/stub-and-mock-harmful/">Are Stubs and Mocks Harmful?</a></h1>
            
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2016-12-18'>
            December 18, 2016</time>
        <span class="author"></span>
        
            <p>5 minute read</p>
        
        
    </div>
</header>


    <section id="social-share">
        <ul class="icons">
            


<li><a href="//twitter.com/share?url=https%3a%2f%2fwww.lvguowei.me%2fpost%2fstub-and-mock-harmful%2f&text=Are%20Stubs%20and%20Mocks%20Harmful%3f&via=" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
</a></li>


<li><a href="//plus.google.com/share?url=https%3a%2f%2fwww.lvguowei.me%2fpost%2fstub-and-mock-harmful%2f" target="_blank" class="share-btn google-plus">
    <i class="fa fa-google-plus"></i>
    <p>Google+</p>
</a></li>


<li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.lvguowei.me%2fpost%2fstub-and-mock-harmful%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
</a></li>


<li><a href="//reddit.com/submit?url=https%3a%2f%2fwww.lvguowei.me%2fpost%2fstub-and-mock-harmful%2f&title=Are%20Stubs%20and%20Mocks%20Harmful%3f" target="_blank" class="share-btn reddit">
    <i class="fa fa-reddit-alien"></i>
    <p>Reddit</p>
</a></li>


<li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.lvguowei.me%2fpost%2fstub-and-mock-harmful%2f&title=Are%20Stubs%20and%20Mocks%20Harmful%3f" target="_blank" class="share-btn linkedin">
    <i class="fa fa-linkedin"></i>
    <p>LinkedIn</p>
</a></li>


<li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fwww.lvguowei.me%2fpost%2fstub-and-mock-harmful%2f&title=Are%20Stubs%20and%20Mocks%20Harmful%3f" target="_blank" class="share-btn stumbleupon">
    <i class="fa fa-stumbleupon"></i>
    <p>StumbleUpon</p>
</a></li>


<li><a href="mailto:?subject=Check out this post by &body=https%3a%2f%2fwww.lvguowei.me%2fpost%2fstub-and-mock-harmful%2f" target="_blank" class="share-btn email">
    <i class="fa fa-envelope"></i>
    <p>Email</p>
</a></li>

        </ul>
    </section>
    

    <div id="content">
        

<p>I stumbled upon this <a href="https://www.youtube.com/watch?v=EaxDl5NPuCA">video</a>, and boy it is so amazing! (if you ignore the annoying audience asking non-stop some annoying questions). This is clearly one of the most inspiring videos I have ever watched. So I must take some notes down and spread the idea as well.</p>

<p>I deeply believe that it is actually easy to make things complicated, on the contrary, it is hard to make things simple and elegant. I found some resonance from the speaker.</p>

<p>Why the speaker thinks that using stubs and mocks are actually harmful?</p>

<h2 id="stubs-v-s-mocks">Stubs v.s. Mocks</h2>

<p>There is a great <a href="http://martinfowler.com/articles/mocksArentStubs.html">essay</a> by Martin Fowler about this topic, go read it before you continue if you haven&rsquo;t done so.</p>

<h2 id="case-study-1-clumsy-input">Case study 1: Clumsy Input</h2>

<p>Here is a bloated configuration interface.</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Config</span> <span class="o">{</span>

  <span class="c1">// Database stuff</span>
  <span class="n">String</span> <span class="nf">getDBHost</span><span class="o">();</span>
  <span class="kt">int</span> <span class="nf">getDBPort</span><span class="o">();</span>
  <span class="kt">int</span> <span class="nf">getMaxThreads</span><span class="o">();</span>
  <span class="kt">int</span> <span class="nf">getConnectionTimeout</span><span class="o">();</span>
  
  <span class="c1">// Potato settings</span>
  <span class="n">String</span> <span class="nf">getDefaultPotatoVarieties</span><span class="o">();</span>
  <span class="kt">int</span> <span class="nf">getMaxPotatoes</span><span class="o">();</span>
  <span class="kt">double</span> <span class="nf">getPotatoShinniness</span><span class="o">();</span>
  
  <span class="c1">// Sacrificial settings</span>
  <span class="kt">int</span> <span class="nf">getBSGoadCount</span><span class="o">();</span>
  <span class="kt">int</span> <span class="nf">getBSChickenCount</span><span class="o">();</span>
  <span class="kt">int</span> <span class="nf">getBSSheepCount</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div>


<p>Here is a class that uses the configuration interface.</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PotatoService</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="nf">PotatoService</span><span class="o">(</span><span class="n">Config</span> <span class="n">config</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">potatoVariety</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getDefaultPotatoVarieties</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">maxPotatoes</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getMaxPotatoes</span><span class="o">();</span>
  <span class="o">}</span>
  
  <span class="kd">public</span> <span class="n">Salad</span> <span class="nf">makePotatoSalad</span><span class="o">()</span> <span class="o">{...}</span>
  
<span class="o">}</span>
</code></pre></div>


<p>Now we want to test the <code>makePotatoSalad</code> function in <code>PotatoService</code>. One can easily think of using a <code>Config</code> stub.</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PotatoServiceTest</span> <span class="o">{</span>
  <span class="n">Config</span> <span class="n">config</span> <span class="o">=</span> <span class="n">Mock</span><span class="o">(</span><span class="n">Config</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  
  <span class="nd">@Before</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">before</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// This is a stub</span>
    <span class="n">when</span><span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="na">getDefaultPotatoVarieties</span><span class="o">()).</span><span class="na">thenReturn</span><span class="o">(</span><span class="s">&quot;pontiac&quot;</span><span class="o">);</span>
    <span class="n">when</span><span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="na">getMaxPotatoes</span><span class="o">()).</span><span class="na">thenReturn</span><span class="o">(</span><span class="mi">33</span><span class="o">);</span>
  <span class="o">}</span>
  
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testMakingSalad</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">PotatoService</span> <span class="n">service</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PotatoService</span><span class="o">(</span><span class="n">config</span><span class="o">);</span>
    <span class="n">Assert</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">service</span><span class="o">.</span><span class="na">makePotatoSalad</span><span class="o">(),</span> <span class="o">...);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>


<p>There are several observations.</p>

<p>First, we stub out the config because it is hard to create and contains stuff that the SUT(System Under Test) doesn&rsquo;t care. So it is better to break up the fat interface into smaller ones.
But this is not the end of the story.</p>

<p>Stare at the <code>PotatoService</code> class a bit harder we will find that it actually needs only two things: <code>potatoVariety</code> and <code>maxPotatoes</code>. Does it matter where they come from? Why does this class needs to know about the <code>Config</code> at all?</p>

<p>We can rewrite the <code>PotatoService</code> as follows:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PotatoService</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="nf">PotatoService</span><span class="o">(</span><span class="n">String</span> <span class="n">variety</span><span class="o">,</span> <span class="kt">int</span> <span class="n">max</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">potatoVariety</span> <span class="o">=</span> <span class="n">variety</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">maxPotatoes</span> <span class="o">=</span> <span class="n">max</span><span class="o">;</span>
  <span class="o">}</span>
  
  <span class="kd">public</span> <span class="n">Salad</span> <span class="nf">makePotatoSalad</span><span class="o">()</span> <span class="o">{...}</span>
  
<span class="o">}</span>
</code></pre></div>


<p>How to pass in the <code>variety</code> and <code>max</code> is someone else&rsquo;s business, probably some factory or DI framework. And here is the test:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PotatoServiceTest</span> <span class="o">{</span>
  
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testMakingSalad</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// No stubs anymore!</span>
    <span class="n">PotatoService</span> <span class="n">service</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PotatoService</span><span class="o">(</span><span class="s">&quot;pontiac&quot;</span><span class="o">,</span> <span class="mi">33</span><span class="o">);</span>
    <span class="n">Assert</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">service</span><span class="o">.</span><span class="na">makePotatoSalad</span><span class="o">(),</span> <span class="o">...);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>


<h2 id="case-study-2-unnecessary-mutable-state">Case study 2: Unnecessary Mutable State</h2>

<p>In this example, a <code>Customer</code> can buy from some <code>VendingMachine</code> from his <code>Wallet</code>.</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Wallet</span> <span class="o">{</span>
  <span class="kt">int</span> <span class="nf">removeCoins</span><span class="o">(</span><span class="kt">int</span> <span class="n">amount</span><span class="o">);</span>
  <span class="kt">int</span> <span class="nf">getAmount</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">VendingMachine</span> <span class="o">{</span>
  <span class="kt">void</span> <span class="nf">insertCoins</span><span class="o">(</span><span class="kt">int</span> <span class="n">amount</span><span class="o">);</span>
  <span class="n">Can</span> <span class="nf">collectCan</span><span class="o">();</span>
  <span class="kt">int</span> <span class="nf">getStoredCash</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Customer</span> <span class="o">{</span>
  <span class="kt">void</span> <span class="nf">buyDrink</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div>


<p>The tests look like this:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomerTest</span> <span class="o">{</span>
  <span class="n">Wallet</span> <span class="n">wallet</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">Wallet</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="n">VendingMachine</span> <span class="n">vendingMachine</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">VendingMachine</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  
  <span class="nd">@Before</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">before</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// These are stubs</span>
    <span class="n">when</span><span class="o">(</span><span class="n">wallet</span><span class="o">.</span><span class="na">removeCoins</span><span class="o">(</span><span class="mi">3</span><span class="o">)).</span><span class="na">thenReturn</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
    <span class="n">when</span><span class="o">(</span><span class="n">vendingMachine</span><span class="o">.</span><span class="na">collectCan</span><span class="o">()).</span><span class="na">thenReturn</span><span class="o">(</span><span class="k">new</span> <span class="n">CokeCan</span><span class="o">());</span>
  <span class="o">}</span>
  
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testBuyDrink</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Customer</span> <span class="n">c</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Customer</span><span class="o">(</span><span class="n">wallet</span><span class="o">,</span> <span class="n">vendingMachine</span><span class="o">);</span>
    <span class="n">c</span><span class="o">.</span><span class="na">buyDrink</span><span class="o">();</span>
    <span class="c1">// These are mocks</span>
    <span class="n">verify</span><span class="o">(</span><span class="n">wallet</span><span class="o">).</span><span class="na">removeCoins</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
    <span class="n">verify</span><span class="o">(</span><span class="n">vendingMachine</span><span class="o">).</span><span class="na">insertCoins</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
    <span class="n">verify</span><span class="o">(</span><span class="n">vendingMachine</span><span class="o">).</span><span class="na">collectCan</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>


<p>Here the SUT is separated, but the stubs and mocks are being too tied to the implementation details. These tests are testing behaviours rather than the final states. What we really care is after all these, what are the final state of the wallet, the vendingMachine and the customer. The wallet and vendingMachine must have the correct amount of money in the end, and the customer gets a can of drink. We care less about what functions are called in what order and such.</p>

<p>The true reason we need the stubs and mocks to help us is that these classes are mutable, then change. So we need to catch the trace of how they changed over time. But if they immutable. then we don&rsquo;t need to trace anymore, we can just see its values. This concept should be very familiar to you if you have some functional programming background. So these classes can be rewritten as follows:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Wallet</span> <span class="o">{</span>
  <span class="kt">int</span> <span class="nf">getAmount</span><span class="o">();</span>
  <span class="n">Wallet</span> <span class="nf">removeCoins</span><span class="o">(</span><span class="kt">int</span> <span class="n">amount</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">VendingMachine</span> <span class="o">{</span>
  <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Can</span><span class="o">&gt;</span> <span class="nf">getCanInTray</span><span class="o">();</span>
  <span class="kt">int</span> <span class="nf">getStoredCash</span><span class="o">();</span>
  <span class="n">VendingMachine</span> <span class="nf">insertCoins</span><span class="o">(</span><span class="kt">int</span> <span class="n">amount</span><span class="o">);</span>
  <span class="n">VendingMachine</span> <span class="nf">collectCan</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Customer</span> <span class="o">{</span>
  <span class="n">Wallet</span> <span class="nf">getWallet</span><span class="o">();</span>
  <span class="n">List</span><span class="o">&lt;</span><span class="n">Can</span><span class="o">&gt;</span> <span class="nf">getCansHeld</span><span class="o">();</span>
  <span class="n">Pair</span><span class="o">&lt;</span><span class="n">VendingMachine</span><span class="o">,</span> <span class="n">Customer</span><span class="o">&gt;</span> <span class="nf">buyDrink</span><span class="o">(</span><span class="n">VendingMachine</span> <span class="n">vendingMachine</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>


<p>Then the tests becomes this:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomerTest</span> <span class="o">{</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testBuyDrink</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Customer</span> <span class="n">c</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Customer</span><span class="o">(</span><span class="k">new</span> <span class="n">Wallet</span><span class="o">(</span><span class="mi">23</span><span class="o">));</span>
    <span class="n">VendingMachine</span> <span class="n">vm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">VendingMachine</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="mi">30</span><span class="o">);</span>
    
    <span class="n">Pair</span><span class="o">&lt;</span><span class="n">VendingMachine</span><span class="o">,</span> <span class="n">Customer</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">buyDrink</span><span class="o">(</span><span class="n">vm</span><span class="o">);</span>
    <span class="n">Customer</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">second</span><span class="o">();</span>
    <span class="n">VendingMachine</span> <span class="n">vm2</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">first</span><span class="o">();</span>
    
    <span class="n">Assert</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="mi">20</span><span class="o">,</span> <span class="n">c2</span><span class="o">.</span><span class="na">getWallet</span><span class="o">().</span><span class="na">getAmount</span><span class="o">());</span>
    <span class="n">Assert</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="mi">9</span><span class="o">,</span> <span class="n">vm2</span><span class="o">.</span><span class="na">getCanInTray</span><span class="o">().</span><span class="na">size</span><span class="o">());</span>
    <span class="n">Assert</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="mi">33</span><span class="o">,</span> <span class="n">vm2</span><span class="o">.</span><span class="na">getStoredCash</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>


<h2 id="case-study-3-essential-effects">Case study 3: Essential effects</h2>

<p>This example shows how to finally deal with the side effects. Sending emails, writing databases and such. We cannot or don&rsquo;t want to test them directly, so using mocks can be helpful here. Like the following example:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">EmailSender</span> <span class="o">{</span>
  <span class="kt">void</span> <span class="nf">sendEmail</span><span class="o">(</span><span class="n">String</span> <span class="n">address</span><span class="o">,</span> <span class="n">Email</span> <span class="n">email</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpecialOffers</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">EmailSender</span> <span class="n">sender</span><span class="o">;</span>
  
  <span class="kt">void</span> <span class="nf">sendSpecialOffers</span><span class="o">(</span><span class="n">Customer</span> <span class="n">customer</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">customer</span><span class="o">.</span><span class="na">isUnsubscribed</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">String</span> <span class="n">content</span> <span class="o">=</span> <span class="s">&quot;Something...&quot;</span><span class="o">;</span>
      <span class="n">sender</span><span class="o">.</span><span class="na">sendEmail</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">getEmailAddress</span><span class="o">(),</span> <span class="k">new</span> <span class="n">Email</span><span class="o">(</span><span class="n">content</span><span class="o">));</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>


<p>When we test, we don&rsquo;t really want to send out emails, so we are going to mock the email sender.</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpecialOfferTest</span> <span class="o">{</span>
  <span class="n">EmailSender</span> <span class="n">sender</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">EmailSender</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  
  <span class="kd">public</span> <span class="nf">testSendEmail</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">SpeicalOffers</span> <span class="n">offers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SpeicalOffers</span><span class="o">(</span><span class="n">sender</span><span class="o">);</span>
    
    <span class="n">offers</span><span class="o">.</span><span class="na">sendSpecialOffers</span><span class="o">(</span><span class="k">new</span> <span class="n">Customer</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="s">&quot;Bob&quot;</span><span class="o">,</span> <span class="s">&quot;foo@bar.com&quot;</span><span class="o">));</span>
    
    <span class="c1">// mock</span>
    <span class="n">verify</span><span class="o">(</span><span class="n">sender</span><span class="o">).</span><span class="na">send</span><span class="o">(</span><span class="s">&quot;foo@bar.com&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Email</span><span class="o">(</span><span class="s">&quot;Something...&quot;</span><span class="o">));</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>


<p>So what we really want to test is the <strong>intent</strong> of sending an email. Can we separate out the <strong>intent</strong> by itself?</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SendEmailIntent</span> <span class="o">{</span>
  <span class="n">String</span> <span class="nf">getAddress</span><span class="o">();</span>
  <span class="n">Email</span> <span class="nf">getEmail</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">interpreter</span> <span class="o">{</span>
  <span class="kt">void</span> <span class="nf">interpret</span><span class="o">(</span><span class="n">SendEmailIntent</span> <span class="n">i</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpecialOffers</span> <span class="o">{</span>
  <span class="n">Optional</span><span class="o">&lt;</span><span class="n">SendEmailIntent</span><span class="o">&gt;</span> <span class="nf">sendSpecialOffers</span><span class="o">(</span><span class="n">Customer</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">c</span><span class="o">.</span><span class="na">isUnsubscribed</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">String</span> <span class="n">content</span> <span class="o">=</span> <span class="s">&quot;Something...&quot;</span><span class="o">;</span>
      <span class="k">return</span> <span class="n">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="k">new</span> <span class="n">SendEmailIntent</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">getEmailAddress</span><span class="o">(),</span> <span class="k">new</span> <span class="n">Email</span><span class="o">(</span><span class="n">content</span><span class="o">)));</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>


<p>Now the tests become:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpecialOfferTest</span> <span class="o">{</span>
  
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSendEmail</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">SpecialOffers</span> <span class="n">offers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SpeicalOffers</span><span class="o">();</span>
    
    <span class="n">SendEmailIntent</span> <span class="n">intent</span> <span class="o">=</span> <span class="n">offers</span><span class="o">.</span><span class="na">sendEmail</span><span class="o">(</span><span class="k">new</span> <span class="n">Customer</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="s">&quot;Bob&quot;</span><span class="o">,</span> <span class="s">&quot;foo@bar.com&quot;</span><span class="o">)).</span><span class="na">get</span><span class="o">();</span>
    
    <span class="n">Assert</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;foo@bar.com&quot;</span><span class="o">,</span> <span class="n">intent</span><span class="o">.</span><span class="na">getAddress</span><span class="o">());</span>
    <span class="n">Assert</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Something...&quot;</span><span class="o">,</span> <span class="n">intent</span><span class="o">.</span><span class="na">getEmail</span><span class="o">().</span><span class="na">getText</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>


<p>These examples really opened my eye as to how you can leverage some of the good parts from FP into OO programming.</p>

    </div>

    <footer>
        <ul class="stats">
    
        

        
        
  <li>
    
    
    

    

    
                        
                        
                            
                        

                    

                    
                        Category
                    
                
            </li>
        
    

    
    
        <li><a href='https://www.lvguowei.me/categories/test-driven-development'>Test Driven Development</a></li>
    
</ul>

    </footer>
</article>
<ul class="actions pagination">
    
        <li><a href="https://www.lvguowei.me/post/coffee-maker/"
                class="button big previous">Coffee Maker - An OOD case study</a></li>
    

    
        <li><a href="https://www.lvguowei.me/post/first-android-lib/"
                class="button big next">My first Android library!</a></li>
    
</ul>



    
        <article class="post">
            <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "lvguoweime" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </article>
    


    </div>
    
<section id="sidebar">

    
        <section id="intro">
            
            
                
                    <a href="https://www.lvguowei.me/" class="logo"><img src="https://www.lvguowei.me/img/logo.jpg" alt="Guowei Lv" /></a>
                
            
            
                <header>
                    <h2>Guowei Lv</h2>
                    <p>Keep sane and code</p>
                </header>
            
            <ul class="icons">
                
                
                    
<li><a href="//github.com/lvguowei" target="_blank" title="GitHub" class="fa fa-github"></a></li>













<li><a href="//lvguowei.deviantart.com/" target="_blank" title="DeviantArt" class="fa fa-deviantart"></a></li>























<li><a href="//linkedin.com/in/lvguowei" target="_blank" title="LinkedIn" class="fa fa-linkedin"></a></li>

















<li><a href="mailto:lvguowei1002@gmail.com" title="Email" class="fa fa-envelope"></a></li>


                
            </ul>
        </section>

    
        <section id="recent-posts">
            <ul class="posts">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://www.lvguowei.me/post/all-you-need-to-know-about-android-espresso-testing-4/">All You Need To Know About Android Espresso Testing (Part IV)</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2017-07-21'>
                                    July 21, 2017</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://www.lvguowei.me/post/all-you-need-to-know-about-android-espresso-testing-3/">All You Need To Know About Android Espresso Testing (Part III)</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2017-07-21'>
                                    July 21, 2017</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://www.lvguowei.me/post/all-you-need-to-know-about-android-espresso-testing-2/">All You Need To Know About Android Espresso Testing (Part II)</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2017-07-21'>
                                    July 21, 2017</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://www.lvguowei.me/post/how-to-follow-hand-made-hero-on-linux/">How To Follow Hand Made Hero On Linux</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2017-07-20'>
                                    July 20, 2017</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://www.lvguowei.me/post/all-you-need-to-know-about-android-espresso-testing/">All You Need To Know About Android Espresso Testing (Part I)</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2017-07-13'>
                                    July 13, 2017</time>
                            </header>
                        </article>
                    </li>
                

                
                    <li>
                        <ul class="actions">
                            <li><a href=
                            
                                "/post/"
                            
                            class="button">View more posts</a></li>
                        </ul>
                    </li>
                
            </ul>
        </section>

    
    
    
    
        <section id="categories">
            <ul class="posts">
                <header>
                    <h3><a href="https://www.lvguowei.me/categories/">Categories</a></h3>
                </header>

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <a href="https://www.lvguowei.me/categories/programming-kata/">programming kata</a>
                                <span style="float:right;">15</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="https://www.lvguowei.me/categories/android-development/">Android Development</a>
                                <span style="float:right;">12</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="https://www.lvguowei.me/categories/finnish-learning/">Finnish Learning</a>
                                <span style="float:right;">10</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="https://www.lvguowei.me/categories/object-oriented-design/">Object Oriented Design</a>
                                <span style="float:right;">7</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="https://www.lvguowei.me/categories/android-library/">Android Library</a>
                                <span style="float:right;">3</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="https://www.lvguowei.me/categories/c&#43;&#43;-primer/">C&#43;&#43; Primer</a>
                                <span style="float:right;">3</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="https://www.lvguowei.me/categories/clojure/">Clojure</a>
                                <span style="float:right;">3</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="https://www.lvguowei.me/categories/painting/">Painting</a>
                                <span style="float:right;">3</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="https://www.lvguowei.me/categories/ranting/">Ranting</a>
                                <span style="float:right;">3</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="https://www.lvguowei.me/categories/refactoring/">Refactoring</a>
                                <span style="float:right;">3</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="https://www.lvguowei.me/categories/hand-made-hero/">Hand Made Hero</a>
                                <span style="float:right;">2</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="https://www.lvguowei.me/categories/sicp/">SICP</a>
                                <span style="float:right;">2</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="https://www.lvguowei.me/categories/test-driven-development/">Test Driven Development</a>
                                <span style="float:right;">2</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="https://www.lvguowei.me/categories/android-programming/">Android Programming</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="https://www.lvguowei.me/categories/books/">Books</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="https://www.lvguowei.me/categories/concurrent-programming/">Concurrent Programming</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="https://www.lvguowei.me/categories/perfume/">Perfume</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
            </ul>
        </section>
    

    
        
        <section class="blurb">
            <h2>About</h2>
            <p>Welcome to my personal website. In here, I talk about programming in general and other cool stuff. Stay tuned!</p>

            <ul class="actions">
                <li><a href="https://www.lvguowei.me/about/" class="button">Learn More</a></li>
            </ul>
        </section>
        

    
        <section id="footer">
            <ul class="icons">
                
                
                    
<li><a href="//github.com/lvguowei" target="_blank" title="GitHub" class="fa fa-github"></a></li>













<li><a href="//lvguowei.deviantart.com/" target="_blank" title="DeviantArt" class="fa fa-deviantart"></a></li>























<li><a href="//linkedin.com/in/lvguowei" target="_blank" title="LinkedIn" class="fa fa-linkedin"></a></li>

















<li><a href="mailto:lvguowei1002@gmail.com" title="Email" class="fa fa-envelope"></a></li>


                
            </ul>

            <p class="copyright">&copy; Guowei Lv. </p>
        </section>

</section>

            </div>
        <a id="back-to-top" href="#" class="fa fa-arrow-up fa-border fa-2x"></a>
        

        
        
            
        

        
        
            <script src="https://www.lvguowei.me/js/jquery.min.js"></script>
            <script src="https://www.lvguowei.me/js/skel.min.js"></script>
            <script src="https://www.lvguowei.me/js/util.js"></script>
            <script src="https://www.lvguowei.me/js/main.js"></script>
            <script src="https://www.lvguowei.me/js/backToTop.js"></script>
            <script src="https://www.lvguowei.me/js/highlight.pack.js"></script>
        

        

            
            <script>hljs.initHighlightingOnLoad();</script>
            
    </body>
</html>

